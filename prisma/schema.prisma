generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis]
}

enum Role {
  USER
  ADMIN
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum TargetType {
  MUSEUM
  REVIEW
  USER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)
  preferences   Json? // e.g. { optInMatch: false }

  collections Collection[]
  folders     Folder[]
  saves       Save[]
  plans       Plan[]
  reviews     Review[]
  challenges  ChallengeProgress[]
  suggestions Suggestion[]
  reports     Report[]            @relation("ReportedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Museum {
  id          String  @id @default(cuid())
  name        String
  description String?
  country     String // ISO Code e.g. "US", "KR"
  city        String
  type        String // e.g. "Public", "Private", "Foundation"
  website     String?
  imageUrl    String?

  latitude  Float
  longitude Float
  location  Unsupported("geometry(Point, 4326)")?

  popularityScore Float @default(0.0)

  exhibitions     Exhibition[]
  saves           Save[]
  reviews         Review[]
  suggestions     Suggestion[]
  planStops       PlanStop[]
  collectionItems CollectionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, city, type])
  @@index([popularityScore])
  @@index([location], type: Gist)
}

model Exhibition {
  id          String    @id @default(cuid())
  museumId    String
  title       String
  description String?
  startDate   DateTime?
  endDate     DateTime?

  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Folder {
  id        String  @id @default(cuid())
  userId    String
  name      String
  isPrivate Boolean @default(true)

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  saves Save[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Save {
  id       String  @id @default(cuid())
  userId   String
  museumId String
  folderId String?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  museum Museum  @relation(fields: [museumId], references: [id], onDelete: Cascade)
  folder Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([userId, museumId])
  // Note: Prisma index definition for multiple fields
  @@index([userId, museumId, folderId])
}

model Plan {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  date      DateTime @default(now()) // The planned date
  createdAt DateTime @default(now())

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stops PlanStop[]

  @@index([userId, date])
}

model PlanStop {
  id              String    @id @default(cuid())
  planId          String
  museumId        String
  order           Int // sequence 0, 1, 2...
  expectedArrival DateTime?

  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  museumId  String
  content   String // max 3 lines enforced in UI/API
  photos    String[] // max 3 URLs
  visitedAt DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  museum          Museum           @relation(fields: [museumId], references: [id], onDelete: Cascade)
  collectionItems CollectionItem[]

  createdAt DateTime @default(now())

  @@index([museumId, createdAt])
  @@index([userId, createdAt])
}

model Collection {
  id          String  @id @default(cuid())
  userId      String
  title       String
  description String?
  isPublic    Boolean @default(false)
  shareSlug   String? @unique

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model CollectionItem {
  id           String  @id @default(cuid())
  collectionId String
  museumId     String
  reviewId     String? // Optional association with a review
  order        Int

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  museum     Museum     @relation(fields: [museumId], references: [id], onDelete: Cascade)
  review     Review?    @relation(fields: [reviewId], references: [id], onDelete: SetNull)
}

model Challenge {
  id          String   @id @default(cuid())
  title       String
  description String
  badgeUrl    String?
  startDate   DateTime
  endDate     DateTime

  progress ChallengeProgress[]

  createdAt DateTime @default(now())
}

model ChallengeProgress {
  id          String    @id @default(cuid())
  userId      String
  challengeId String
  status      String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  completedAt DateTime?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
}

model AlertSubscription {
  id        String   @id @default(cuid())
  email     String
  type      String // e.g. "NEW_EXHIBITION", "MONTHLY_CHALLENGE"
  createdAt DateTime @default(now())
}

model Suggestion {
  id       String           @id @default(cuid())
  museumId String? // null if suggesting a new museum entirely
  userId   String? // null if anonymous
  data     Json // the suggested edits
  status   SuggestionStatus @default(PENDING)

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  museum Museum? @relation(fields: [museumId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Report {
  id         String       @id @default(cuid())
  reporterId String
  targetType TargetType
  targetId   String
  reason     String
  status     ReportStatus @default(PENDING)

  reporter User @relation("ReportedBy", fields: [reporterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String // e.g. "APPROVE_SUGGESTION", "BAN_USER"
  target    String
  timestamp DateTime @default(now())
}
