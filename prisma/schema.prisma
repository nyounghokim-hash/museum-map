generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated_v2/client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

model User {
  id            String              @id @default(cuid())
  name          String?
  email         String?             @unique
  emailVerified DateTime?
  image         String?
  role          Role                @default(USER)
  preferences   Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  username      String?             @unique
  password      String?
  lastIp        String?
  challenges    ChallengeProgress[]
  collections   Collection[]
  feedbacks     Feedback[]
  folders       Folder[]
  notifications Notification[]
  plans         Plan[]
  reports       Report[]            @relation("ReportedBy")
  reviews       Review[]
  saves         Save[]
  suggestions   Suggestion[]
}

model Story {
  id           String        @id @default(cuid())
  title        String
  content      String
  author       String?
  previewImage String?
  status       ContentStatus @default(DRAFT)
  views        Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  contentEn    String?
  titleEn      String?
  description  String?
  infoTable    Json?
  artworks     Json?
  museums      StoryMuseum[]

  @@index([status])
  @@index([createdAt])
  @@map("Blog")
}

model StoryMuseum {
  storyId  String
  museumId String
  museum   Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
  story    Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@id([storyId, museumId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  messageEn String?
  titleEn   String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Museum {
  id                 String                   @id @default(cuid())
  name               String
  description        String?
  country            String
  city               String
  type               String
  website            String?
  imageUrl           String?
  latitude           Float
  longitude          Float
  location           Unsupported("geometry")?
  popularityScore    Float                    @default(0.0)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  openingHours       Json?
  visitorInfo        Json?
  lastExhibitionSync DateTime?
  collectionItems    CollectionItem[]
  exhibitions        Exhibition[]
  planStops          PlanStop[]
  reviews            Review[]
  saves              Save[]
  stories            StoryMuseum[]
  suggestions        Suggestion[]

  @@index([country, city, type])
  @@index([popularityScore])
  @@index([location], type: Gist)
}

model Exhibition {
  id          String    @id @default(cuid())
  museumId    String
  title       String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  imageUrl    String?
  link        String?
  source      String?
  museum      Museum    @relation(fields: [museumId], references: [id], onDelete: Cascade)
}

model Folder {
  id        String   @id @default(cuid())
  userId    String
  name      String
  isPrivate Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  saves     Save[]
}

model Save {
  id        String   @id @default(cuid())
  userId    String
  museumId  String
  folderId  String?
  createdAt DateTime @default(now())
  folder    Folder?  @relation(fields: [folderId], references: [id])
  museum    Museum   @relation(fields: [museumId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, museumId])
  @@index([userId, museumId, folderId])
}

model Plan {
  id        String     @id @default(cuid())
  userId    String
  title     String?
  date      DateTime   @default(now())
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stops     PlanStop[]

  @@index([userId, date])
}

model PlanStop {
  id              String    @id @default(cuid())
  planId          String
  museumId        String
  order           Int
  expectedArrival DateTime?
  museum          Museum    @relation(fields: [museumId], references: [id], onDelete: Cascade)
  plan            Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
}

model Review {
  id              String           @id @default(cuid())
  userId          String
  museumId        String
  content         String
  photos          String[]
  visitedAt       DateTime         @default(now())
  createdAt       DateTime         @default(now())
  country         String?
  ipAddress       String?
  collectionItems CollectionItem[]
  museum          Museum           @relation(fields: [museumId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([museumId, createdAt])
  @@index([userId, createdAt])
}

model Collection {
  id          String           @id @default(cuid())
  userId      String
  title       String
  description String?
  isPublic    Boolean          @default(false)
  shareSlug   String?          @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       CollectionItem[]

  @@index([userId, createdAt])
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  museumId     String
  reviewId     String?
  order        Int
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  museum       Museum     @relation(fields: [museumId], references: [id], onDelete: Cascade)
  review       Review?    @relation(fields: [reviewId], references: [id])
}

model Challenge {
  id          String              @id @default(cuid())
  title       String
  description String
  badgeUrl    String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime            @default(now())
  progress    ChallengeProgress[]
}

model ChallengeProgress {
  userId      String
  challengeId String
  completedAt DateTime?
  completed   Boolean   @default(false)
  progress    Int       @default(0)
  updatedAt   DateTime  @updatedAt
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, challengeId])
}

model Feedback {
  id         String   @id @default(cuid())
  userId     String?
  content    String
  type       String   @default("general")
  category   String?
  targetId   String?
  targetName String?
  createdAt  DateTime @default(now())
  reply      String?
  updatedAt  DateTime @default(now()) @updatedAt
  user       User?    @relation(fields: [userId], references: [id])
}

model AlertSubscription {
  id        String   @id @default(cuid())
  email     String
  type      String
  createdAt DateTime @default(now())
}

model Suggestion {
  id        String           @id @default(cuid())
  museumId  String?
  userId    String?
  data      Json
  status    SuggestionStatus @default(PENDING)
  createdAt DateTime         @default(now())
  museum    Museum?          @relation(fields: [museumId], references: [id], onDelete: Cascade)
  user      User?            @relation(fields: [userId], references: [id])
}

model Report {
  id         String       @id @default(cuid())
  reporterId String
  targetType TargetType
  targetId   String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  reporter   User         @relation("ReportedBy", fields: [reporterId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  target    String
  timestamp DateTime @default(now())
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum Role {
  USER
  ADMIN
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  DELETED
}

enum TargetType {
  MUSEUM
  REVIEW
  USER
}
