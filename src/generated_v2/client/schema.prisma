generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  output          = "../src/generated_v2/client"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis]
}

enum Role {
  USER
  ADMIN
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  DELETED
}

enum TargetType {
  MUSEUM
  REVIEW
  USER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  username      String?   @unique
  email         String?   @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)
  preferences   Json? // e.g. { optInMatch: false }
  lastIp        String?

  collections   Collection[]
  folders       Folder[]
  saves         Save[]
  plans         Plan[]
  reviews       Review[]
  challenges    ChallengeProgress[]
  feedbacks     Feedback[]
  suggestions   Suggestion[]
  reports       Report[]            @relation("ReportedBy")
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Story {
  id           String        @id @default(cuid())
  title        String
  titleEn      String?
  content      String        @db.Text
  contentEn    String?       @db.Text
  description  String?       @db.Text
  author       String?
  previewImage String?
  status       ContentStatus @default(DRAFT)
  views        Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  museums StoryMuseum[]

  @@index([status])
  @@index([createdAt])
  @@map("Blog")
}

model StoryMuseum {
  storyId  String
  museumId String

  story  Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)
  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)

  @@id([storyId, museumId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String? // null = broadcast to all users (including guests)
  type      String // e.g. "SYSTEM", "EXHIBITION_ALERT", "ADMIN_PUSH"
  title     String
  titleEn   String?
  message   String
  messageEn String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Museum {
  id           String  @id @default(cuid())
  name         String
  description  String?
  country      String // ISO Code e.g. "US", "KR"
  city         String
  type         String // e.g. "Public", "Private", "Foundation"
  website      String?
  imageUrl     String?
  openingHours Json? // e.g. { "mon": "10:00-18:00", "tue": "10:00-18:00", ... }

  latitude  Float
  longitude Float
  location  Unsupported("geometry(Point, 4326)")?

  popularityScore Float @default(0.0)

  lastExhibitionSync DateTime?

  exhibitions     Exhibition[]
  saves           Save[]
  reviews         Review[]
  suggestions     Suggestion[]
  planStops       PlanStop[]
  collectionItems CollectionItem[]
  stories         StoryMuseum[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, city, type])
  @@index([popularityScore])
  @@index([location], type: Gist)
}

model Exhibition {
  id          String    @id @default(cuid())
  museumId    String
  title       String
  description String?
  imageUrl    String?
  link        String?
  source      String? // "SERPER", "MANUAL", "WIKIPEDIA"
  startDate   DateTime?
  endDate     DateTime?

  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Folder {
  id        String  @id @default(cuid())
  userId    String
  name      String
  isPrivate Boolean @default(true)

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  saves Save[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Save {
  id       String  @id @default(cuid())
  userId   String
  museumId String
  folderId String?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  museum Museum  @relation(fields: [museumId], references: [id], onDelete: Cascade)
  folder Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([userId, museumId])
  // Note: Prisma index definition for multiple fields
  @@index([userId, museumId, folderId])
}

model Plan {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  date      DateTime @default(now()) // The planned date
  createdAt DateTime @default(now())

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stops PlanStop[]

  @@index([userId, date])
}

model PlanStop {
  id              String    @id @default(cuid())
  planId          String
  museumId        String
  order           Int // sequence 0, 1, 2...
  expectedArrival DateTime?

  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  museum Museum @relation(fields: [museumId], references: [id], onDelete: Cascade)
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  museumId  String
  content   String // max 3 lines enforced in UI/API
  photos    String[] // max 3 URLs
  ipAddress String? // for nickname generation
  country   String? // ISO country from IP
  visitedAt DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  museum          Museum           @relation(fields: [museumId], references: [id], onDelete: Cascade)
  collectionItems CollectionItem[]

  createdAt DateTime @default(now())

  @@index([museumId, createdAt])
  @@index([userId, createdAt])
}

model Collection {
  id          String  @id @default(cuid())
  userId      String
  title       String
  description String?
  isPublic    Boolean @default(false)
  shareSlug   String? @unique

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model CollectionItem {
  id           String  @id @default(cuid())
  collectionId String
  museumId     String
  reviewId     String? // Optional association with a review
  order        Int

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  museum     Museum     @relation(fields: [museumId], references: [id], onDelete: Cascade)
  review     Review?    @relation(fields: [reviewId], references: [id], onDelete: SetNull)
}

model Challenge {
  id          String   @id @default(cuid())
  title       String
  description String
  badgeUrl    String?
  startDate   DateTime
  endDate     DateTime

  progress ChallengeProgress[]

  createdAt DateTime @default(now())
}

model ChallengeProgress {
  userId      String
  challengeId String
  progress    Int       @default(0) // Count of criteria met
  completed   Boolean   @default(false)
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@id([userId, challengeId])
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?
  content   String
  reply     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model AlertSubscription {
  id        String   @id @default(cuid())
  email     String
  type      String // e.g. "NEW_EXHIBITION", "MONTHLY_CHALLENGE"
  createdAt DateTime @default(now())
}

model Suggestion {
  id       String           @id @default(cuid())
  museumId String? // null if suggesting a new museum entirely
  userId   String? // null if anonymous
  data     Json // the suggested edits
  status   SuggestionStatus @default(PENDING)

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  museum Museum? @relation(fields: [museumId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Report {
  id         String       @id @default(cuid())
  reporterId String
  targetType TargetType
  targetId   String
  reason     String
  status     ReportStatus @default(PENDING)

  reporter User @relation("ReportedBy", fields: [reporterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String // e.g. "APPROVE_SUGGESTION", "BAN_USER"
  target    String
  timestamp DateTime @default(now())
}
